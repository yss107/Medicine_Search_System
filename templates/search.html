{% extends "base.html" %}

{% block title %}Search Results - Medicine Search System{% endblock %}

{% block content %}
<div class="container">
    <div class="search-page">
        <h2>Search Medicines</h2>
        
        <div class="search-box">
            <form action="{{ url_for('search') }}" method="get" class="search-form">
                <input 
                    type="text" 
                    name="q" 
                    placeholder="Search by medicine name, composition, or use..." 
                    class="search-input"
                    value="{{ request.args.get('q', '') }}"
                >
                <button type="submit" class="search-button">Search</button>
            </form>
        </div>

        <div class="filters">
            <form action="{{ url_for('search') }}" method="get" class="filter-form">
                <input type="hidden" name="q" value="{{ request.args.get('q', '') }}">
                
                <div class="filter-group">
                    <label for="manufacturer">Manufacturer:</label>
                    <input 
                        type="text" 
                        id="manufacturer" 
                        name="manufacturer" 
                        placeholder="Filter by manufacturer"
                        value="{{ request.args.get('manufacturer', '') }}"
                    >
                </div>
                
                <div class="filter-group">
                    <label for="discontinued">Status:</label>
                    <select id="discontinued" name="discontinued">
                        <option value="all" {% if request.args.get('discontinued', 'all') == 'all' %}selected{% endif %}>All</option>
                        <option value="active" {% if request.args.get('discontinued') == 'active' %}selected{% endif %}>Active Only</option>
                        <option value="discontinued" {% if request.args.get('discontinued') == 'discontinued' %}selected{% endif %}>Discontinued</option>
                    </select>
                </div>
                
                <button type="submit" class="filter-button">Apply Filters</button>
            </form>
        </div>

        {% if query or request.args.get('manufacturer') %}
            <div class="results-info">
                <p>Found <strong>{{ medicines|length }}</strong> medicine(s)</p>
                {% if current_user.is_authenticated %}
                    <form method="POST" action="{{ url_for('save_search') }}" style="display: inline;">
                        <input type="hidden" name="query" value="{{ query }}">
                        <input type="hidden" name="manufacturer" value="{{ request.args.get('manufacturer', '') }}">
                        <input type="hidden" name="discontinued" value="{{ request.args.get('discontinued', 'all') }}">
                        <button type="submit" class="btn btn-secondary">ðŸ’¾ Save This Search</button>
                    </form>
                {% endif %}
            </div>

            {% if medicines %}
                <div class="selection-tools">
                    <p>Select medicines to compare or check interactions:</p>
                    <form id="compare-form">
                        <button type="button" onclick="compareSelected()" class="btn btn-primary">Compare Selected</button>
                        <button type="button" onclick="checkInteractions()" class="btn btn-secondary">Check Interactions</button>
                    </form>
                </div>
                
                <div class="medicines-grid">
                    {% for medicine in medicines %}
                    <div class="medicine-card">
                        <div class="medicine-checkbox">
                            <input type="checkbox" id="med-{{ loop.index0 }}" value="{{ loop.index0 }}" class="medicine-select">
                        </div>
                        <div class="medicine-header">
                            <h3><label for="med-{{ loop.index0 }}">{{ medicine.name }}</label></h3>
                            {% if medicine.is_discontinued == 'Yes' %}
                                <span class="badge badge-discontinued">Discontinued</span>
                            {% else %}
                                <span class="badge badge-active">Active</span>
                            {% endif %}
                        </div>
                        <div class="medicine-info">
                            <p><strong>Manufacturer:</strong> {{ medicine.manufacturer }}</p>
                            <p><strong>Composition:</strong> {{ medicine.composition }}</p>
                            <p><strong>Pack Size:</strong> {{ medicine.pack_size_label }}</p>
                            <p class="medicine-uses"><strong>Uses:</strong> {{ medicine.uses[:100] }}{% if medicine.uses|length > 100 %}...{% endif %}</p>
                        </div>
                        <a href="{{ url_for('medicine_detail', index=loop.index0) }}" class="btn btn-primary">View Details</a>
                    </div>
                    {% endfor %}
                </div>
                
                <script>
                function compareSelected() {
                    const selected = Array.from(document.querySelectorAll('.medicine-select:checked')).map(cb => cb.value);
                    if (selected.length < 2) {
                        alert('Please select at least 2 medicines to compare');
                        return;
                    }
                    window.location.href = '{{ url_for("compare") }}?indices=' + selected.join(',');
                }
                
                function checkInteractions() {
                    const selected = Array.from(document.querySelectorAll('.medicine-select:checked')).map(cb => cb.value);
                    if (selected.length < 2) {
                        alert('Please select at least 2 medicines to check interactions');
                        return;
                    }
                    window.location.href = '{{ url_for("interactions") }}?indices=' + selected.join(',');
                }
                </script>
            {% else %}
                <div class="no-results">
                    <p>No medicines found matching your search criteria.</p>
                    <p>Try different keywords or clear the filters.</p>
                </div>
            {% endif %}
        {% else %}
            <div class="search-prompt">
                <p>Enter a search query above to find medicines.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
