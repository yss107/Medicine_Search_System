{% extends "base.html" %}

{% block title %}Price Comparison - Medicine Search System{% endblock %}

{% block content %}
<div class="container">
    <h1>üí∞ Medicine Price Comparison</h1>
    <p class="subtitle">Compare prices across different pharmacies</p>

    <div class="search-section">
        <form onsubmit="searchMedicine(event)" class="search-form">
            <input type="text" id="medicine-search" placeholder="Search for a medicine..." class="form-control">
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
    </div>

    <div id="search-results" class="medicine-list"></div>
    <div id="price-results" class="price-comparison"></div>
</div>

<style>
.search-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 30px;
    border-radius: 10px;
    margin: 20px 0;
}

.search-form {
    display: flex;
    gap: 10px;
    max-width: 600px;
    margin: 0 auto;
}

.search-form input {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 5px;
}

.medicine-list {
    margin: 20px 0;
}

.medicine-item {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    cursor: pointer;
    transition: all 0.3s;
}

.medicine-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.price-comparison {
    margin-top: 30px;
}

.price-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px 10px 0 0;
}

.price-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.price-card {
    background: white;
    border: 2px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s;
}

.price-card:hover {
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

.price-card.best-price {
    border-color: #28a745;
    background: #f0fff4;
}

.price-card.best-price .badge {
    background: #28a745;
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8em;
    margin-bottom: 10px;
    display: inline-block;
}

.pharmacy-name {
    font-size: 1.2em;
    font-weight: bold;
    color: #667eea;
    margin: 10px 0;
}

.price {
    font-size: 2em;
    font-weight: bold;
    color: #333;
    margin: 15px 0;
}

.price-card.best-price .price {
    color: #28a745;
}

.price-info {
    margin: 10px 0;
    font-size: 0.9em;
    color: #666;
}

.rating {
    color: #ffa500;
    margin: 5px 0;
}

.availability {
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.85em;
    display: inline-block;
    margin: 5px 0;
}

.availability.in-stock {
    background: #d4edda;
    color: #155724;
}

.availability.limited {
    background: #fff3cd;
    color: #856404;
}

.savings {
    background: #28a745;
    color: white;
    padding: 10px;
    border-radius: 5px;
    margin-top: 20px;
    text-align: center;
    font-weight: bold;
}
</style>

<script>
let medicines = [];

function searchMedicine(event) {
    event.preventDefault();
    const query = document.getElementById('medicine-search').value.toLowerCase();
    
    if (!query) {
        return;
    }
    
    // Search in our database
    fetch(`/api/v1/medicines/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            medicines = data.medicines;
            displaySearchResults(medicines);
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('search-results').innerHTML = 
                '<p style="color: red;">Error searching medicines. Please try again.</p>';
        });
}

function displaySearchResults(results) {
    const resultsDiv = document.getElementById('search-results');
    
    if (results.length === 0) {
        resultsDiv.innerHTML = '<p>No medicines found. Try a different search term.</p>';
        return;
    }
    
    let html = '<h2>Select a Medicine to Compare Prices:</h2>';
    results.forEach((medicine, index) => {
        html += `
            <div class="medicine-item" onclick="comparePrices(${medicine.index})">
                <h3>${medicine.name}</h3>
                <p><strong>Manufacturer:</strong> ${medicine.manufacturer}</p>
                <p><strong>Composition:</strong> ${medicine.composition}</p>
            </div>
        `;
    });
    
    resultsDiv.innerHTML = html;
}

function comparePrices(medicineIndex) {
    fetch(`/api/prices/compare?medicine=${medicineIndex}`)
        .then(response => response.json())
        .then(data => {
            displayPriceComparison(data);
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('price-results').innerHTML = 
                '<p style="color: red;">Error loading prices. Please try again.</p>';
        });
}

function displayPriceComparison(data) {
    const resultsDiv = document.getElementById('price-results');
    
    // Find best price
    const lowestPrice = data.lowest_price;
    const highestPrice = data.highest_price;
    const savings = (highestPrice - lowestPrice).toFixed(2);
    
    let html = `
        <div class="price-header">
            <h2>${data.medicine.name}</h2>
            <p>${data.medicine.manufacturer}</p>
        </div>
        <div class="price-cards">
    `;
    
    data.prices.forEach(price => {
        const isBest = price.price === lowestPrice;
        const availClass = price.availability === 'In Stock' ? 'in-stock' : 'limited';
        
        html += `
            <div class="price-card ${isBest ? 'best-price' : ''}">
                ${isBest ? '<span class="badge">üèÜ Best Price</span>' : ''}
                <div class="pharmacy-name">${price.pharmacy}</div>
                <div class="price">‚Çπ${price.price.toFixed(2)}</div>
                <div class="rating">‚≠ê ${price.rating}/5</div>
                <div class="availability ${availClass}">${price.availability}</div>
                <div class="price-info">üöö ${price.delivery}</div>
                ${isBest ? `<div class="price-info" style="color: #28a745; font-weight: bold;">Save ‚Çπ${savings}!</div>` : ''}
            </div>
        `;
    });
    
    html += `
        </div>
        <div class="savings">
            üí∞ Maximum Savings: ‚Çπ${savings} by choosing the best price!
        </div>
    `;
    
    resultsDiv.innerHTML = html;
    resultsDiv.scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}
